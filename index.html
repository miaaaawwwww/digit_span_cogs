<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digit Span Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
        
        #container {
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        
        #main-text {
            font-size: 48px;
            line-height: 1.5;
            margin-bottom: 40px;
        }
        
        #digit-display {
            font-size: 72px;
            font-weight: bold;
        }
        
        #input-display {
            font-size: 48px;
            margin-top: 20px;
            min-height: 60px;
            border-bottom: 2px solid #fff;
            padding: 10px;
        }
        
        .instruction {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="main-text"></div>
        <div id="digit-display"></div>
        <div id="input-display" class="hidden"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION - GOOGLE APPS SCRIPT WEB APP URL
        // ============================================================================
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKqM6frDma-QJbMI0MxG9958ykeGMIcoo2r2TleUzCP9qAAHQNOXExCUkpc7B2LGIx7Q/exec';
        
        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        
        const CONDITIONS = ['Pop', 'Rap', 'EDM', 'Classical', 'Silence'];
        const AUDIO_FILES = {
            'Pop': 'audio/pop.mp3',
            'Rap': 'audio/rap.mp3',
            'EDM': 'audio/edm.mp3',
            'Classical': 'audio/classical.mp3'
        };
        const SEQUENCE_LENGTHS = [5, 6, 7, 8];
        const NUM_TRIALS = 4;
        
        let participantId = '';
        let condition = '';
        let currentAudio = null;
        let trialData = [];
        let currentTrial = 0;
        let trials = [];
        let responseStartTime = 0;
        let currentResponse = '';
        let startTime = '';
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function generateParticipantId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `P${timestamp}_${random}`;
        }
        
        function randomCondition() {
            return CONDITIONS[Math.floor(Math.random() * CONDITIONS.length)];
        }
        
        function generateTrials() {
            trials = [];
            for (let i = 0; i < NUM_TRIALS; i++) {
                const length = SEQUENCE_LENGTHS[i];
                let sequence = '';
                for (let j = 0; j < length; j++) {
                    sequence += Math.floor(Math.random() * 10).toString();
                }
                trials.push({
                    index: i + 1,
                    sequence: sequence,
                    length: length
                });
            }
        }
        
        function showText(text) {
            document.getElementById('main-text').innerHTML = text;
            document.getElementById('digit-display').textContent = '';
            document.getElementById('input-display').classList.add('hidden');
        }
        
        function showDigit(digit) {
            document.getElementById('main-text').textContent = '';
            document.getElementById('digit-display').textContent = digit;
            document.getElementById('input-display').classList.add('hidden');
        }
        
        function showInputScreen() {
            document.getElementById('main-text').innerHTML = 'Type the digits you remember (in order).<br>Press ENTER to submit.';
            document.getElementById('digit-display').textContent = '';
            document.getElementById('input-display').classList.remove('hidden');
            document.getElementById('input-display').textContent = '_';
            currentResponse = '';
            responseStartTime = Date.now();
        }
        
        function updateInput() {
            document.getElementById('input-display').textContent = currentResponse || '_';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // ============================================================================
        // AUDIO MANAGEMENT
        // ============================================================================
        
        function loadAndPlayAudio() {
            if (condition === 'Silence') {
                return Promise.resolve(true);
            }
            
            return new Promise((resolve) => {
                const audioPath = AUDIO_FILES[condition];
                currentAudio = new Audio(audioPath);
                currentAudio.loop = true;
                currentAudio.volume = 0.3;
                
                currentAudio.addEventListener('canplaythrough', () => {
                    currentAudio.play()
                        .then(() => resolve(true))
                        .catch(() => {
                            showText(`Audio file missing or cannot play: ${audioPath}<br><br>Press SPACE to continue without audio.`);
                            resolve(false);
                        });
                }, { once: true });
                
                currentAudio.addEventListener('error', () => {
                    showText(`Audio file missing: ${audioPath}<br><br>Press SPACE to continue without audio.`);
                    resolve(false);
                });
                
                currentAudio.load();
            });
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }
        
        // ============================================================================
        // GOOGLE SHEETS INTEGRATION
        // ============================================================================
        
        async function sendToGoogleSheets(data) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Note: no-cors means we can't read the response, but the data is sent
                return true;
            } catch (error) {
                console.error('Error sending data:', error);
                return false;
            }
        }
        
        async function saveAllData() {
            const participantData = {
                type: 'participant',
                participant_id: participantId,
                condition: condition,
                start_time_iso: startTime
            };
            
            // Send participant data
            await sendToGoogleSheets(participantData);
            
            // Send each trial
            for (let trial of trialData) {
                const trialDataToSend = {
                    type: 'trial',
                    ...trial
                };
                await sendToGoogleSheets(trialDataToSend);
                await sleep(100); // Small delay between requests
            }
        }
        
        // ============================================================================
        // TRIAL LOGIC
        // ============================================================================
        
        async function runTrial(trialIndex) {
            const trial = trials[trialIndex];
            const trialStart = new Date().toISOString();
            
            // Show "Get ready" between trials
            if (trialIndex > 0) {
                showText('Get ready...');
                await sleep(1000);
            }
            
            // Fixation
            showDigit('+');
            await sleep(500);
            
            // Show sequence
            for (let digit of trial.sequence) {
                showDigit(digit);
                await sleep(1000);
            }
            
            // Get response
            return new Promise((resolve) => {
                showInputScreen();
                
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        const rt = Date.now() - responseStartTime;
                        const trialEnd = new Date().toISOString();
                        const correct = currentResponse === trial.sequence ? 1 : 0;
                        
                        trialData.push({
                            participant_id: participantId,
                            condition: condition,
                            trial_index: trial.index,
                            sequence_presented: trial.sequence,
                            response: currentResponse,
                            correct: correct,
                            sequence_length: trial.length,
                            rt_ms: rt,
                            trial_start_iso: trialStart,
                            trial_end_iso: trialEnd
                        });
                        
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve();
                    } else if (e.key === 'Backspace') {
                        e.preventDefault();
                        currentResponse = currentResponse.slice(0, -1);
                        updateInput();
                    } else if (e.key.length === 1 && /[0-9]/.test(e.key)) {
                        currentResponse += e.key;
                        updateInput();
                    }
                };
                
                document.addEventListener('keydown', handleKeyDown);
            });
        }
        
        async function runAllTrials() {
            for (let i = 0; i < NUM_TRIALS; i++) {
                await runTrial(i);
            }
        }
        
        // ============================================================================
        // MAIN FLOW
        // ============================================================================
        
        function waitForSpace() {
            return new Promise((resolve) => {
                const handleKeyDown = (e) => {
                    if (e.key === ' ' || e.key === 'Spacebar') {
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve();
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
            });
        }
        
        async function runStudy() {
            // Initialize
            participantId = generateParticipantId();
            condition = randomCondition();
            startTime = new Date().toISOString();
            generateTrials();
            
            // Enter fullscreen
            if (document.documentElement.requestFullscreen) {
                try {
                    await document.documentElement.requestFullscreen();
                } catch (e) {
                    // Fullscreen failed, continue anyway
                }
            }
            
            // Welcome
            showText('This study tests memory while background<br>audio may be playing.<br><br>Press SPACE to begin.');
            await waitForSpace();
            
            // Instructions
            showText('You will see sequences of digits.<br>Memorize them and type them back in order.<br><br>Press ENTER to submit.');
            await waitForSpace();
            
            // Load audio
            const audioLoaded = await loadAndPlayAudio();
            if (!audioLoaded && condition !== 'Silence') {
                await waitForSpace();
            }
            
            // Run trials
            await runAllTrials();
            
            // Stop audio
            stopAudio();
            
            // Save data to Google Sheets
            showText('Saving your responses...');
            await saveAllData();
            
            // Thank you
            showText('Thanks! Your responses have been recorded.<br>You may close this window.');
            
            // Exit fullscreen after a delay
            await sleep(3000);
            if (document.exitFullscreen) {
                try {
                    await document.exitFullscreen();
                } catch (e) {
                    // Ignore error
                }
            }
        }
        
        // Start the study when page loads
        window.addEventListener('load', () => {
            runStudy();
        });
        
        // Handle escape key to exit
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                stopAudio();
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });
    </script>
</body>
</html>
