<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Digit Span Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            touch-action: manipulation;
        }
        
        #container {
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        
        #main-text {
            font-size: clamp(24px, 5vw, 48px);
            line-height: 1.5;
            margin-bottom: 40px;
        }
        
        #digit-display {
            font-size: clamp(48px, 10vw, 72px);
            font-weight: bold;
        }
        
        #input-display {
            font-size: clamp(32px, 7vw, 48px);
            margin-top: 20px;
            min-height: 60px;
            border-bottom: 2px solid #fff;
            padding: 10px;
            letter-spacing: 0.5em;
        }
        
        .button {
            background-color: #fff;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: clamp(18px, 4vw, 24px);
            border-radius: 8px;
            cursor: pointer;
            margin: 20px auto;
            display: inline-block;
            min-width: 200px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .button:active {
            background-color: #ccc;
        }
        
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 300px;
            margin: 30px auto;
        }
        
        .number-btn {
            background-color: #333;
            color: #fff;
            border: 2px solid #666;
            padding: 20px;
            font-size: clamp(24px, 6vw, 32px);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .number-btn:active {
            background-color: #555;
        }
        
        .action-btn {
            background-color: #444;
            color: #fff;
            border: 2px solid #888;
        }
        
        .submit-btn {
            background-color: #0a0;
            color: #fff;
            border: 2px solid #0c0;
            grid-column: span 3;
        }
        
        .submit-btn:active {
            background-color: #080;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="main-text"></div>
        <div id="digit-display"></div>
        <div id="input-display" class="hidden"></div>
        <div id="button-container"></div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION - GOOGLE APPS SCRIPT WEB APP URL
        // ============================================================================
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKqM6frDma-QJbMI0MxG9958ykeGMIcoo2r2TleUzCP9qAAHQNOXExCUkpc7B2LGIx7Q/exec';
        
        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        
        const CONDITIONS = ['Pop', 'Rap', 'EDM', 'Classical', 'Silence'];
        const AUDIO_FILES = {
            'Pop': 'audio/pop.mp3',
            'Rap': 'audio/rap.mp3',
            'EDM': 'audio/edm.mp3',
            'Classical': 'audio/classical.mp3'
        };
        const SEQUENCE_LENGTHS = [5, 6, 7, 8];
        const NUM_TRIALS = 4;
        
        let participantId = '';
        let condition = '';
        let currentAudio = null;
        let trialData = [];
        let currentTrial = 0;
        let trials = [];
        let responseStartTime = 0;
        let currentResponse = '';
        let startTime = '';
        let audioContext = null;
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function generateParticipantId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `P${timestamp}_${random}`;
        }
        
        function randomCondition() {
            return CONDITIONS[Math.floor(Math.random() * CONDITIONS.length)];
        }
        
        function generateTrials() {
            trials = [];
            for (let i = 0; i < NUM_TRIALS; i++) {
                const length = SEQUENCE_LENGTHS[i];
                let sequence = '';
                for (let j = 0; j < length; j++) {
                    sequence += Math.floor(Math.random() * 10).toString();
                }
                trials.push({
                    index: i + 1,
                    sequence: sequence,
                    length: length
                });
            }
        }
        
        function clearUI() {
            document.getElementById('main-text').innerHTML = '';
            document.getElementById('digit-display').textContent = '';
            document.getElementById('input-display').classList.add('hidden');
            document.getElementById('button-container').innerHTML = '';
        }
        
        function showText(text, showButton = false, buttonText = 'Continue', buttonCallback = null) {
            clearUI();
            document.getElementById('main-text').innerHTML = text;
            
            if (showButton) {
                const btn = document.createElement('button');
                btn.className = 'button';
                btn.textContent = buttonText;
                btn.onclick = buttonCallback;
                document.getElementById('button-container').appendChild(btn);
            }
        }
        
        function showDigit(digit) {
            clearUI();
            document.getElementById('digit-display').textContent = digit;
        }
        
        function showInputScreen(callback) {
            clearUI();
            document.getElementById('main-text').innerHTML = 'Type the digits you remember (in order)';
            document.getElementById('input-display').classList.remove('hidden');
            document.getElementById('input-display').textContent = '_';
            currentResponse = '';
            responseStartTime = Date.now();
            
            createNumberPad(callback);
        }
        
        function createNumberPad(submitCallback) {
            const container = document.getElementById('button-container');
            const pad = document.createElement('div');
            pad.className = 'number-pad';
            
            // Numbers 1-9
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.onclick = () => addDigit(i.toString());
                pad.appendChild(btn);
            }
            
            // Backspace button
            const backBtn = document.createElement('button');
            backBtn.className = 'number-btn action-btn';
            backBtn.textContent = 'â†';
            backBtn.onclick = () => removeDigit();
            pad.appendChild(backBtn);
            
            // Zero button
            const zeroBtn = document.createElement('button');
            zeroBtn.className = 'number-btn';
            zeroBtn.textContent = '0';
            zeroBtn.onclick = () => addDigit('0');
            pad.appendChild(zeroBtn);
            
            // Clear button
            const clearBtn = document.createElement('button');
            clearBtn.className = 'number-btn action-btn';
            clearBtn.textContent = 'Clear';
            clearBtn.onclick = () => clearResponse();
            pad.appendChild(clearBtn);
            
            // Submit button
            const submitBtn = document.createElement('button');
            submitBtn.className = 'number-btn submit-btn';
            submitBtn.textContent = 'Submit';
            submitBtn.onclick = submitCallback;
            pad.appendChild(submitBtn);
            
            container.appendChild(pad);
        }
        
        function addDigit(digit) {
            currentResponse += digit;
            updateInput();
        }
        
        function removeDigit() {
            currentResponse = currentResponse.slice(0, -1);
            updateInput();
        }
        
        function clearResponse() {
            currentResponse = '';
            updateInput();
        }
        
        function updateInput() {
            const display = document.getElementById('input-display');
            display.textContent = currentResponse || '_';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(() => {});
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }
        
        // ============================================================================
        // AUDIO MANAGEMENT
        // ============================================================================
        
        async function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        }
        
        async function loadAndPlayAudio() {
            if (condition === 'Silence') {
                return true;
            }
            
            try {
                await initAudioContext();
                
                const audioPath = AUDIO_FILES[condition];
                currentAudio = new Audio(audioPath);
                currentAudio.loop = true;
                currentAudio.volume = 0.3;
                
                return new Promise((resolve) => {
                    currentAudio.addEventListener('canplaythrough', async () => {
                        try {
                            await currentAudio.play();
                            resolve(true);
                        } catch (e) {
                            resolve(false);
                        }
                    }, { once: true });
                    
                    currentAudio.addEventListener('error', () => {
                        resolve(false);
                    }, { once: true });
                    
                    currentAudio.load();
                });
            } catch (e) {
                return false;
            }
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }
        
        // ============================================================================
        // GOOGLE SHEETS INTEGRATION
        // ============================================================================
        
        async function sendToGoogleSheets(data) {
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                return true;
            } catch (error) {
                console.error('Error sending data:', error);
                return false;
            }
        }
        
        async function saveAllData() {
            const participantData = {
                type: 'participant',
                participant_id: participantId,
                condition: condition,
                start_time_iso: startTime
            };
            
            await sendToGoogleSheets(participantData);
            
            for (let trial of trialData) {
                const trialDataToSend = {
                    type: 'trial',
                    ...trial
                };
                await sendToGoogleSheets(trialDataToSend);
                await sleep(100);
            }
        }
        
        // ============================================================================
        // TRIAL LOGIC
        // ============================================================================
        
        async function runTrial(trialIndex) {
            const trial = trials[trialIndex];
            const trialStart = new Date().toISOString();
            
            if (trialIndex > 0) {
                showText('Get ready...');
                await sleep(1000);
            }
            
            showDigit('+');
            await sleep(500);
            
            for (let digit of trial.sequence) {
                showDigit(digit);
                await sleep(1000);
            }
            
            return new Promise((resolve) => {
                showInputScreen(() => {
                    const rt = Date.now() - responseStartTime;
                    const trialEnd = new Date().toISOString();
                    const correct = currentResponse === trial.sequence ? 1 : 0;
                    
                    trialData.push({
                        participant_id: participantId,
                        condition: condition,
                        trial_index: trial.index,
                        sequence_presented: trial.sequence,
                        response: currentResponse,
                        correct: correct,
                        sequence_length: trial.length,
                        rt_ms: rt,
                        trial_start_iso: trialStart,
                        trial_end_iso: trialEnd
                    });
                    
                    resolve();
                });
            });
        }
        
        async function runAllTrials() {
            for (let i = 0; i < NUM_TRIALS; i++) {
                await runTrial(i);
            }
        }
        
        // ============================================================================
        // MAIN FLOW
        // ============================================================================
        
        async function runStudy() {
            participantId = generateParticipantId();
            condition = randomCondition();
            startTime = new Date().toISOString();
            generateTrials();
            
            await new Promise(resolve => {
                showText('This study tests memory while background<br>audio may be playing.<br><br>Tap to begin.', true, 'Begin', resolve);
            });
            
            enterFullscreen();
            
            await new Promise(resolve => {
                showText('You will see sequences of digits.<br>Memorize them and type them back in order.<br><br>Tap to continue.', true, 'Continue', resolve);
            });
            
            await initAudioContext();
            
            const audioLoaded = await loadAndPlayAudio();
            if (!audioLoaded && condition !== 'Silence') {
                await new Promise(resolve => {
                    showText(`Audio could not play.<br><br>Continuing without audio.`, true, 'Continue', resolve);
                });
            }
            
            await runAllTrials();
            
            stopAudio();
            
            showText('Saving your responses...');
            await saveAllData();
            
            showText('Thanks! Your responses have been recorded.<br>You may close this window.');
            
            await sleep(3000);
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
            }
        }
        
        window.addEventListener('load', () => {
            runStudy();
        });
        
        // Keyboard support for desktop users
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                stopAudio();
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });
    </script>
</body>
</html>
